<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.coolcollege.intelligent.dao.store.StoreDeviceMappingMapper">
    <resultMap id="BaseResultMap" type="com.coolcollege.intelligent.model.store.StoreDeviceMappingDO">
        <!--
          WARNING - @mbggenerated
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="store_id" property="storeId" jdbcType="VARCHAR"/>
        <result column="device_id" property="deviceId" jdbcType="VARCHAR"/>
        <result column="biz_inst_id" property="bizInstId" jdbcType="VARCHAR"/>
        <result column="punch_group_id" property="punchGroupId" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="BIGINT"/>
        <result column="create_name" property="createName" jdbcType="VARCHAR"/>
    </resultMap>

    <delete id="batchDeleteDevicesMappingByStoreIds">
        delete from store_device_mapping_${enterpriseId}
        where store_id in
        <foreach collection="storeIds" item="storeId" separator="," open="(" close=")">
            #{storeId, jdbcType=VARCHAR}
        </foreach>
    </delete>



    <select id="batchGetDeviceByStoreIds" resultType="com.coolcollege.intelligent.model.store.StoreDeviceMappingDO">
        select
            id as id,
            store_id as storeId,
            device_id as deviceId,
            biz_inst_id as bizInstId,
            punch_group_id as punchGroupId,
            create_time as createTime,
            create_name as createName
        from store_device_mapping_${enterpriseId}
        where  1=1
        <if test="storeIds!=null  and storeIds.size>0">
         and  store_id in
        <foreach collection="storeIds" item="storeId" separator="," open="(" close=")">
            #{storeId, jdbcType=VARCHAR}
        </foreach>
        </if>
    </select>

    <insert id="addStoreDeviceMapping">
        insert into store_device_mapping_${enterpriseId}
        (store_id,device_id,biz_inst_id,punch_group_id,create_time,create_name)
        values
        (
        #{storeDeviceMappingDO.storeId, jdbcType=VARCHAR},
        #{storeDeviceMappingDO.deviceId, jdbcType=VARCHAR},
        #{storeDeviceMappingDO.bizInstId, jdbcType=VARCHAR},
        #{storeDeviceMappingDO.punchGroupId, jdbcType=VARCHAR},
        #{storeDeviceMappingDO.createTime, jdbcType=BIGINT},
        #{storeDeviceMappingDO.createName, jdbcType=VARCHAR}
        )
    </insert>

    <select id="getDevicesMappingByDeviceId" resultType="com.coolcollege.intelligent.model.store.StoreDeviceMappingDO">
        select
            store_id as storeId,
            device_id as deviceId,
            biz_inst_id as bizInstId,
            punch_group_id as punchGroupId,
            create_time as createTime,
            create_name as createName
        from store_device_mapping_${enterpriseId}
        where device_id=#{deviceId, jdbcType=VARCHAR}
    </select>

    <update id="updateDevicesMappingByStoreId">
        update store_device_mapping_${enterpriseId} set device_id=#{deviceId, jdbcType=VARCHAR},lock_flag = 0
        where store_id=#{storeId, jdbcType=VARCHAR}
    </update>

    <insert id="batchInsertDeviceMapping">
        insert into store_device_mapping_${enterpriseId}
        (store_id,device_id,biz_inst_id,punch_group_id,create_time,create_name)
        values
        <foreach collection="storeDeviceMappings" item="storeDeviceMapping" separator=",">
            (
            #{storeDeviceMapping.storeId, jdbcType=VARCHAR},
            #{storeDeviceMapping.deviceId, jdbcType=VARCHAR},
            #{storeDeviceMapping.bizInstId, jdbcType=VARCHAR},
            #{storeDeviceMapping.punchGroupId, jdbcType=VARCHAR},
            #{storeDeviceMapping.createTime, jdbcType=BIGINT},
            #{storeDeviceMapping.createName, jdbcType=VARCHAR}
            )
        </foreach>
    </insert>

    <select id="getDeviceMapping" resultType="com.coolcollege.intelligent.model.store.StoreDeviceMappingDO">
        select
            m.store_id as storeId,
            m.device_id as deviceId,
            m.biz_inst_id as bizInstId,
            m.punch_group_id as punchGroupId,
            m.create_time as createTime,
            m.create_name as createName
        from store_device_mapping_${enterpriseId} m
        where m.store_id = #{storeId, jdbcType=VARCHAR}
    </select>

    <select id="getSyncDeviceMapping"
            resultType="com.coolcollege.intelligent.model.store.StoreDeviceMappingDO">
        select
        m.store_id as storeId,
        m.device_id as deviceId,
        m.biz_inst_id as bizInstId,
        m.punch_group_id as punchGroupId,
        m.create_time as createTime,
        m.create_name as createName
        from store_device_mapping_${enterpriseId} m
        <if test="dingIds != null and dingIds.size() > 0">
            left join store_${enterpriseId} s using (store_id)
        </if>
        where 1 = 1
        <if test="storeIds != null and storeIds.size() > 0 ">
            and m.store_id in
            <foreach collection="storeIds" item="storeId" open="(" separator="," close=")">
                #{storeId, jdbcType=VARCHAR}
            </foreach>
        </if>
        <if test="dingIds != null and dingIds.size() > 0">
            and s.ding_id in
            <foreach collection="dingIds" item="dingId" open="(" separator="," close=")">
                #{dingId}
            </foreach>
        </if>
    </select>

    <update id="updateLockFlag">
        update  store_device_mapping_${enterpriseId} set lock_flag = #{lockFlag, jdbcType=INTEGER}
        where device_id = #{newDeviceId, jdbcType=VARCHAR}
        and store_id = #{storeId, jdbcType=VARCHAR}
    </update>
</mapper>