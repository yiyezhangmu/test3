<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coolcollege.intelligent.dao.newstore.NsStoreMapper">
    <resultMap id="BaseResultMap" type="com.coolcollege.intelligent.model.newstore.NsStoreDO">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="deleted" jdbcType="BIT" property="deleted"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="create_date" jdbcType="DATE" property="createDate"/>
        <result column="create_user_id" jdbcType="VARCHAR" property="createUserId"/>
        <result column="create_user_name" jdbcType="VARCHAR" property="createUserName"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="update_user_id" jdbcType="VARCHAR" property="updateUserId"/>
        <result column="update_user_name" jdbcType="VARCHAR" property="updateUserName"/>
        <result column="direct_user_id" jdbcType="VARCHAR" property="directUserId"/>
        <result column="direct_user_name" jdbcType="VARCHAR" property="directUserName"/>
        <result column="real_store_id" jdbcType="VARCHAR" property="realStoreId"/>
        <result column="region_id" jdbcType="BIGINT" property="regionId"/>
        <result column="region_path" jdbcType="VARCHAR" property="regionPath"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="type" jdbcType="VARCHAR" property="type"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>
        <result column="store_address" jdbcType="VARCHAR" property="storeAddress"/>
        <result column="location_address" jdbcType="VARCHAR" property="locationAddress"/>
        <result column="contact_name" jdbcType="VARCHAR" property="contactName"/>
        <result column="contact_phone" jdbcType="VARCHAR" property="contactPhone"/>
        <result column="avatar" jdbcType="VARCHAR" property="avatar"/>
        <result column="progress" jdbcType="DECIMAL" property="progress"/>
        <result column="visit_time" jdbcType="TIMESTAMP" property="visitTime"/>
    </resultMap>
    <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs"
               type="com.coolcollege.intelligent.model.newstore.NsStoreDO">
        <result column="address_point" jdbcType="BINARY" property="addressPoint"/>
    </resultMap>

    <resultMap extends="BaseResultMap" id="pointMap" type="com.coolcollege.intelligent.model.newstore.dto.NsStoreDTO">
        <result column="longitude" jdbcType="BINARY" property="longitude"/>
        <result column="latitude" jdbcType="BINARY" property="latitude"/>
    </resultMap>

    <sql id="Base_Column_List">
        id
        , deleted, create_time, create_date, create_user_id, create_user_name, update_time,
    update_user_id, update_user_name, direct_user_id, direct_user_name, real_store_id, 
    region_id, region_path, name, type, status, store_address, location_address, contact_name, 
    contact_phone, avatar, progress, visit_time
    </sql>
    <sql id="Blob_Column_List">
        address_point
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="ResultMapWithBLOBs">
        select
        <include refid="Base_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from ns_store_${enterpriseId}
        where id = #{id,jdbcType=BIGINT}
    </select>
    <select id="selectByIds" resultMap="ResultMapWithBLOBs">
        select
        <include refid="Base_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from ns_store_${enterpriseId}
        where id in
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id,jdbcType=BIGINT}
        </foreach>
    </select>
    <select id="selectCountByStoreTypeAndStatus"
            resultType="com.coolcollege.intelligent.model.newstore.dto.NsCommonNumDTO">
        select `type` as newStoreType,
        sum(case `status` when 'ongoing' then 1 else 0 end) as ongoingNum,
        sum(case `status` when 'completed' then 1 else 0 end) as completedNum,
        sum(case `status` when 'failed' then 1 else 0 end) as failedNum
        from ns_store_${enterpriseId}
        where region_id = #{regionId}
        and create_date &gt;= #{beginDate,jdbcType=DATE} and create_date &lt;= #{endDate,jdbcType=DATE}
        and deleted = 0
        group by `type`
        order by `type`
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        delete
        from ns_store_${enterpriseId}
        where id = #{id,jdbcType=BIGINT}
    </delete>
    <insert id="insertSelective" parameterType="com.coolcollege.intelligent.model.newstore.NsStoreDO">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into ns_store_${enterpriseId}
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="record.deleted != null">
                deleted,
            </if>
            <if test="record.createTime != null">
                create_time,
            </if>
            <if test="record.createDate != null">
                create_date,
            </if>
            <if test="record.createUserId != null">
                create_user_id,
            </if>
            <if test="record.createUserName != null">
                create_user_name,
            </if>
            <if test="record.updateTime != null">
                update_time,
            </if>
            <if test="record.updateUserId != null">
                update_user_id,
            </if>
            <if test="record.updateUserName != null">
                update_user_name,
            </if>
            <if test="record.directUserId != null">
                direct_user_id,
            </if>
            <if test="record.directUserName != null">
                direct_user_name,
            </if>
            <if test="record.realStoreId != null">
                real_store_id,
            </if>
            <if test="record.regionId != null">
                region_id,
            </if>
            <if test="record.regionPath != null">
                region_path,
            </if>
            <if test="record.name != null">
                name,
            </if>
            <if test="record.type != null">
                type,
            </if>
            <if test="record.status != null">
                status,
            </if>
            <if test="record.storeAddress != null">
                store_address,
            </if>
            <if test="record.locationAddress != null">
                location_address,
            </if>
            <if test="record.contactName != null">
                contact_name,
            </if>
            <if test="record.contactPhone != null">
                contact_phone,
            </if>
            <if test="record.avatar != null">
                avatar,
            </if>
            <if test="record.addressPoint != null">
                address_point,
            </if>
            <if test="record.progress != null">
                progress,
            </if>
            <if test="record.visitTime != null">
                visitTime,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="record.deleted != null">
                #{record.deleted,jdbcType=BIT},
            </if>
            <if test="record.createTime != null">
                #{record.createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.createDate != null">
                #{record.createDate,jdbcType=DATE},
            </if>
            <if test="record.createUserId != null">
                #{record.createUserId,jdbcType=VARCHAR},
            </if>
            <if test="record.createUserName != null">
                #{record.createUserName,jdbcType=VARCHAR},
            </if>
            <if test="record.updateTime != null">
                #{record.updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.updateUserId != null">
                #{record.updateUserId,jdbcType=VARCHAR},
            </if>
            <if test="record.updateUserName != null">
                #{record.updateUserName,jdbcType=VARCHAR},
            </if>
            <if test="record.directUserId != null">
                #{record.directUserId,jdbcType=VARCHAR},
            </if>
            <if test="record.directUserName != null">
                #{record.directUserName,jdbcType=VARCHAR},
            </if>
            <if test="record.realStoreId != null">
                #{record.realStoreId,jdbcType=VARCHAR},
            </if>
            <if test="record.regionId != null">
                #{record.regionId,jdbcType=BIGINT},
            </if>
            <if test="record.regionPath != null">
                #{record.regionPath,jdbcType=VARCHAR},
            </if>
            <if test="record.name != null">
                #{record.name,jdbcType=VARCHAR},
            </if>
            <if test="record.type != null">
                #{record.type,jdbcType=VARCHAR},
            </if>
            <if test="record.status != null">
                #{record.status,jdbcType=VARCHAR},
            </if>
            <if test="record.storeAddress != null">
                #{record.storeAddress,jdbcType=VARCHAR},
            </if>
            <if test="record.locationAddress != null">
                #{record.locationAddress,jdbcType=VARCHAR},
            </if>
            <if test="record.contactName != null">
                #{record.contactName,jdbcType=VARCHAR},
            </if>
            <if test="record.contactPhone != null">
                #{record.contactPhone,jdbcType=VARCHAR},
            </if>
            <if test="record.avatar != null">
                #{record.avatar,jdbcType=VARCHAR},
            </if>
            <if test="record.addressPoint != null">
                ST_GeomFromText(#{record.addressPoint,jdbcType=OTHER}),
            </if>
            <if test="record.progress != null">
                #{record.progress,jdbcType=DECIMAL},
            </if>
            <if test="record.visitTime != null">
                #{record.visitTime,jdbcType=TIMESTAMP}
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.coolcollege.intelligent.model.newstore.NsStoreDO">
        update ns_store_${enterpriseId}
        <set>
            <if test="record.deleted != null">
                deleted = #{record.deleted,jdbcType=BIT},
            </if>
            <if test="record.createTime != null">
                create_time = #{record.createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.createDate != null">
                create_date = #{record.createDate,jdbcType=DATE},
            </if>
            <if test="record.createUserId != null">
                create_user_id = #{record.createUserId,jdbcType=VARCHAR},
            </if>
            <if test="record.createUserName != null">
                create_user_name = #{record.createUserName,jdbcType=VARCHAR},
            </if>
            <if test="record.updateTime != null">
                update_time = #{record.updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.updateUserId != null">
                update_user_id = #{record.updateUserId,jdbcType=VARCHAR},
            </if>
            <if test="record.updateUserName != null">
                update_user_name = #{record.updateUserName,jdbcType=VARCHAR},
            </if>
            <if test="record.directUserId != null">
                direct_user_id = #{record.directUserId,jdbcType=VARCHAR},
            </if>
            <if test="record.directUserName != null">
                direct_user_name = #{record.directUserName,jdbcType=VARCHAR},
            </if>
            <if test="record.realStoreId != null">
                real_store_id = #{record.realStoreId,jdbcType=VARCHAR},
            </if>
            <if test="record.regionId != null">
                region_id = #{record.regionId,jdbcType=BIGINT},
            </if>
            <if test="record.regionPath != null">
                region_path = #{record.regionPath,jdbcType=VARCHAR},
            </if>
            <if test="record.name != null">
                name = #{record.name,jdbcType=VARCHAR},
            </if>
            <if test="record.type != null">
                type = #{record.type,jdbcType=VARCHAR},
            </if>
            <if test="record.status != null">
                status = #{record.status,jdbcType=VARCHAR},
            </if>
            <if test="record.storeAddress != null">
                store_address = #{record.storeAddress,jdbcType=VARCHAR},
            </if>
            <if test="record.locationAddress != null">
                location_address = #{record.locationAddress,jdbcType=VARCHAR},
            </if>
            <if test="record.contactName != null">
                contact_name = #{record.contactName,jdbcType=VARCHAR},
            </if>
            <if test="record.contactPhone != null">
                contact_phone = #{record.contactPhone,jdbcType=VARCHAR},
            </if>
            <if test="record.avatar != null">
                avatar = #{record.avatar,jdbcType=VARCHAR},
            </if>
            <if test="record.addressPoint != null">
                address_point = ST_GeomFromText(#{record.addressPoint,jdbcType=OTHER}),
            </if>
            <if test="record.progress != null">
                progress = #{record.progress,jdbcType=DECIMAL},
            </if>
            <if test="record.visitTime != null">
                visit_time = #{record.visitTime,jdbcType=TIMESTAMP}
            </if>
        </set>
        where id = #{record.id,jdbcType=BIGINT}
    </update>
    <update id="batchUpdate">
        update ns_store_${enterpriseId}
        set
        direct_user_id = CASE id
        <foreach collection="list" item="record">
            WHEN #{record.id} THEN #{record.directUserId}
        </foreach>
        END,
        direct_user_name = CASE id
        <foreach collection="list" item="record">
            WHEN #{record.id} THEN #{record.directUserName}
        </foreach>
        END,
        update_time = CASE id
        <foreach collection="list" item="record">
            WHEN #{record.id} THEN #{record.updateTime}
        </foreach>
        END,
        update_user_id = CASE id
        <foreach collection="list" item="record">
            WHEN #{record.id} THEN #{record.updateUserId}
        </foreach>
        END,
        update_user_name = CASE id
        <foreach collection="list" item="record">
            WHEN #{record.id} THEN #{record.updateUserName}
        </foreach>
        END
        where
        id in
        <foreach collection="list" item="record" open="(" separator="," close=")">
            #{record.id}
        </foreach>
    </update>
    <update id="correctRegionPath">
        UPDATE ns_store_${enterpriseId} a
        INNER JOIN region_${enterpriseId} b ON a.region_id = b.id
        SET a.region_path = b.region_path
        WHERE a.region_path != b.region_path;
    </update>
    <sql id="dynamicQuery">
        <trim prefix="WHERE" prefixOverrides="AND | OR">
            <if test="null != id">
                and t.id = #{id,jdbcType=BIGINT}
            </if>
            <if test="null != deleted">
                and t.deleted = #{deleted,jdbcType=BIT}
            </if>
            <if test="null != createTime">
                and t.create_time = #{createTime,jdbcType=TIMESTAMP}
            </if>
            <if test="null != createDate">
                and t.create_date = #{createDate,jdbcType=DATE}
            </if>
            <if test="null != createUserId">
                and t.create_user_id = #{createUserId,jdbcType=VARCHAR}
            </if>
            <if test="null != createUserName">
                and t.create_user_name = #{createUserName,jdbcType=VARCHAR}
            </if>
            <if test="null != updateTime">
                and t.update_time = #{updateTime,jdbcType=TIMESTAMP}
            </if>
            <if test="null != updateUserId">
                and t.update_user_id = #{updateUserId,jdbcType=VARCHAR}
            </if>
            <if test="null != updateUserName">
                and t.update_user_name = #{updateUserName,jdbcType=VARCHAR}
            </if>
            <if test="null != directUserId">
                and t.direct_user_id = #{directUserId,jdbcType=VARCHAR}
            </if>
            <if test="null != directUserName">
                and t.direct_user_name = #{directUserName,jdbcType=VARCHAR}
            </if>
            <if test="null != realStoreId">
                and t.real_store_id = #{realStoreId,jdbcType=VARCHAR}
            </if>
            <if test="null != regionId">
                and t.region_id = #{regionId,jdbcType=BIGINT}
            </if>
            <if test="null != regionPath">
                and t.region_path = #{regionPath,jdbcType=VARCHAR}
            </if>
            <if test="null != name">
                and t.name = #{name,jdbcType=VARCHAR}
            </if>
            <if test="null != type">
                and t.type = #{type,jdbcType=VARCHAR}
            </if>
            <if test="null != status">
                and t.status = #{status,jdbcType=VARCHAR}
            </if>
            <if test="null != storeAddress">
                and t.store_address = #{storeAddress,jdbcType=VARCHAR}
            </if>
            <if test="null != locationAddress">
                and t.location_address = #{locationAddress,jdbcType=VARCHAR}
            </if>
            <if test="null != contactName">
                and t.contact_name = #{contactName,jdbcType=VARCHAR}
            </if>
            <if test="null != contactPhone">
                and t.contact_phone = #{contactPhone,jdbcType=VARCHAR}
            </if>
            <if test="null != avatar">
                and t.avatar = #{avatar,jdbcType=VARCHAR}
            </if>
            <if test="null != addressPoint">
                and t.address_point = #{addressPoint,jdbcType=BINARY}
            </if>
        </trim>
    </sql>

    <sql id="commonQuery">
        <trim prefixOverrides="AND | OR">
            <if test="query.regionId != null">
                and region_id = #{query.regionId}
            </if>
            <if test="query.createTimeStart != null">
                and create_date >= #{query.createTimeStart, jdbcType=DATE}
            </if>
            <if test="query.createTimeEnd != null">
                and create_date &lt;= #{query.createTimeEnd, jdbcType=DATE}
            </if>
            <if test="query.name != null and query.name != ''">
                and name like concat(trim(#{query.name}),'%')
            </if>
            <if test="query.typeList != null and query.typeList.size > 0">
                and type in
                <foreach collection="query.typeList" close=")" open="(" separator="," item="item">
                    #{item}
                </foreach>
            </if>
            <if test="query.statusList != null and query.statusList.size > 0">
                and status in
                <foreach collection="query.statusList" close=")" open="(" separator="," item="item">
                    #{item}
                </foreach>
            </if>
            <if test="query.directUserId != null and query.directUserId != ''">
                and direct_user_id = #{query.directUserId}
            </if>
            <if test="query.createUserId != null and query.createUserId != ''">
                and create_user_id = #{query.createUserId}
            </if>
            and deleted = 0
        </trim>
    </sql>

    <select id="selectAllByQuery" resultMap="pointMap">
        select
        <include refid="Base_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        ,
        ST_X(address_point)longitude, ST_Y(address_point) as latitude
        from ns_store_${enterpriseId}
        <where>
            <include refid="commonQuery"/>
        </where>
        <choose>
            <when test="query.longitude != null and query.longitude != ''">
                ORDER BY ST_Distance_Sphere(Point( #{query.longitude}, #{query.latitude}), address_point) asc
            </when>
            <otherwise>
                order by create_time desc
            </otherwise>
        </choose>
    </select>

    <select id="getNsStoreDTOById" parameterType="java.lang.Long" resultMap="pointMap">
        select
        <include refid="Base_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>,
        ST_X(address_point)longitude, ST_Y(address_point) as latitude
        from ns_store_${enterpriseId}
        where id = #{id,jdbcType=BIGINT}
    </select>
    <select id="selectStoreCount" resultType="java.lang.Long">
        select
        count(*)
        from ns_store_${enterpriseId}
        <where>
            <include refid="commonQuery"/>
        </where>
    </select>
    <select id="selectCountByCreateUserIdAndStoreName" resultType="java.lang.Long">
        select
        count(*)
        from ns_store_${enterpriseId}
        <where>
            create_user_id = #{createUserId}
            and
            `name` = #{newStoreName}
            <if test="newStoreId != null">
               and id != #{newStoreId}
            </if>
        </where>
    </select>

</mapper>